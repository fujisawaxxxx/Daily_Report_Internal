処理実行
コード修正時のサーバー停止＆再起動
PowerShellで実行
「& "C:\tools\nssm\nssm.exe" status daily-report-internal
& "C:\tools\nssm\nssm.exe" status caddy」

## 運用メモ（Windows サーバー／Waitress＋IIS or Caddy）

### 目的
- Django 管理画面ベースの日報システムを Windows サーバーで安定運用するための手順・設定・備忘録。

### リポジトリと配置
- リポジトリ: `https://github.com/<ORG>/<REPO>.git`（例: `fujisawaxxxx/Daily_Report_Internal`）
- 配置先: `C:\srv\Daily_Report_Internal`
- 逆プロキシ: IIS（ARR＋URL Rewrite）または Caddy のいずれか

## 初回セットアップ手順（PowerShell）
1) 取得
```powershell
cd C:\srv\Daily_Report_Internal
git clone https://github.com/<ORG>/<REPO>.git .
```

2) 仮想環境と依存
```powershell
py -3 -m venv .venv
.\.venv\Scripts\Activate.ps1
.\.venv\Scripts\python.exe -m pip install --upgrade pip
.\.venv\Scripts\python.exe -m pip install -r requirements.txt
.\.venv\Scripts\python.exe -m pip install waitress
```

3) 本番設定
- `.env`（`C:\srv\Daily_Report_Internal\.env`）例:
```
SECRET_KEY=十分長いランダム文字列
URL_SET=your-host-or-ip
EMAIL_HOST_USER=
EMAIL_HOST_PASSWORD=
```
- `config/settings.py` 要点:
  - `DEBUG = False`
  - `ALLOWED_HOSTS = ['your-host-or-ip']`
  - 逆プロキシ（HTTPS 終端）利用時:
    - `SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')`
    - `USE_X_FORWARDED_HOST = True`
  - Django 4+ の場合（必要に応じて）:
    - `CSRF_TRUSTED_ORIGINS = ['http://your-host-or-ip', 'https://your-host-or-ip']`
  - SQLite の同時書き込み待機（推奨）:
    - `DATABASES['default']['OPTIONS'] = {'timeout': 20}`
  - 静的ファイル出力先（未指定なら）:
    - `STATIC_ROOT = BASE_DIR / 'static'`

4) 初期化・静的ファイル
```powershell
python manage.py migrate
python manage.py collectstatic --noinput
# 初回のみ
python manage.py createsuperuser
```

5) Waitress で起動テスト
```powershell
waitress-serve --listen=127.0.0.1:8001 config.wsgi:application
# http://127.0.0.1:8001/admin を確認 → Ctrl+C で停止
```

## 常駐化（Windows サービス：NSSM）
1) インストール設定
```powershell
C:\tools\nssm\nssm.exe install daily-report-internal "C:\srv\Daily_Report_Internal\.venv\Scripts\waitress-serve.exe" ^
--listen=127.0.0.1:8001 config.wsgi:application
```
- Startup directory: `C:\srv\Daily_Report_Internal`
- ログ（任意）: `C:\srv\Daily_Report_Internal\logs\waitress-out.log` / `waitress-err.log`

2) 起動・制御
```powershell
C:\tools\nssm\nssm.exe start daily-report-internal
# 停止/再起動
C:\tools\nssm\nssm.exe stop daily-report-internal
C:\tools\nssm\nssm.exe restart daily-report-internal
```

## リバースプロキシ設定

### パターンA: IIS（ARR＋URL Rewrite）
1) 役割と機能
- 「URL Rewrite」「Application Request Routing（ARR）」をインストール
- ARR の「サーバープロキシ設定」で「プロキシを有効にする」をオン

2) サイト設定
- バインド: 80（HTTP）／必要に応じて 443（HTTPS 証明書設定）
- URL Rewrite → 空の規則を追加:
  - 名前: `ReverseProxyToWaitress`
  - 参照パターン: `(.*)`
  - アクション: `Rewrite`
  - 送信先 URL: `http://127.0.0.1:8001/{R:0}`
- ARR のプロキシ設定:
  - 「オリジナルの Host ヘッダーを保持」オン
  - 「HTTP X-Forwarded-For ヘッダーの追加」オン
  - タイムアウトは 60〜120 秒程度に調整可

3) 静的ファイル `/static/`
- 仮想ディレクトリ `static` を作成し、物理パスを `C:\srv\Daily_Report_Internal\static` に設定
- 必要に応じて MIME Type を追加（例: `.svg` など）

### パターンB: Caddy
- `C:\srv\Daily_Report_Internal\Caddyfile` 例:
```caddy
your-host-or-ip {
    handle_path /static/* {
        root * C:\srv\Daily_Report_Internal\static
        file_server
    }
    reverse_proxy 127.0.0.1:8001
}
```
- サービス化（例: NSSM）
```powershell
C:\tools\nssm\nssm.exe install caddy "C:\path\to\caddy.exe" run --config "C:\srv\Daily_Report_Internal\Caddyfile" --watch
C:\tools\nssm\nssm.exe start caddy
```

### 本番用 固定値（決定事項の反映）
- 採用逆プロキシ: Caddy
- 公開ホスト/IP: `192.168.1.196`
- `.env`（`C:\srv\Daily_Report_Internal\.env`）例:
```
SECRET_KEY=十分長いランダム文字列
URL_SET=192.168.1.196
EMAIL_HOST_USER=
EMAIL_HOST_PASSWORD=
```
- `config/settings.py` 要点（抜粋）:
```python
DEBUG = False
ALLOWED_HOSTS = ['192.168.1.196']
CSRF_TRUSTED_ORIGINS = [
    'http://192.168.1.196',
    'https://192.168.1.196',
]
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
USE_X_FORWARDED_HOST = True
```
- `Caddyfile`（`C:\srv\Daily_Report_Internal\Caddyfile`）:
```caddy
192.168.1.196 {
    handle_path /static/* {
        root * C:\srv\Daily_Report_Internal\static
        file_server
    }
    reverse_proxy 127.0.0.1:8001
}
```
- NSSM コマンド（Waitress/Caddy サービス化）:
```powershell
# Waitress（Django本体）
C:\tools\nssm\nssm.exe install daily-report-internal "C:\srv\Daily_Report_Internal\.venv\Scripts\waitress-serve.exe" ^
--listen=127.0.0.1:8001 config.wsgi:application
C:\tools\nssm\nssm.exe start daily-report-internal

# Caddy（リバースプロキシ）
C:\tools\nssm\nssm.exe install caddy "C:\path\to\caddy.exe" run --config "C:\srv\Daily_Report_Internal\Caddyfile" --watch
C:\tools\nssm\nssm.exe start caddy
```

## 運用（更新手順）
```powershell
cd C:\srv\Daily_Report_Internal
git pull
.\.venv\Scripts\python.exe -m pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput
C:\tools\nssm\nssm.exe restart daily-report-internal
```

## バックアップ
- `C:\srv\Daily_Report_Internal\db.sqlite3` とプロジェクト一式を定期コピー
- 可能であればサービス停止→コピー→起動

## CSV 入出力メモ
### エクスポート
- 文字コード: `cp932`
- カラム: 日付, ユーザー, 開始, 終了, 作業内容, 得意先, 担当者, 報告事項, コメント, 上司確認, 提出状態
- 明細がない日報は空欄で出力

### インポート
- 文字コード: `cp932`（Excel 取り込み時は「65001/UTF-8」ではなく日本語（シフトJIS系）を選択）
- 行フォーマット（11列）:
  - 0: 日付 `%Y-%m-%d`
  - 1: ユーザー名（`User.username`）
  - 2/3: 開始/終了 `%H:%M:%S`（両方ある場合のみ明細作成）
  - 4: 作業内容, 5: 得意先, 6: 担当者
  - 7: 報告事項, 8: コメント
  - 9: 上司確認（'確認済' で True）
  - 10: 提出状態（'提出済' で True）
- `DailyReport` は `(user, date)` で `get_or_create`
- 未登録ユーザー行の扱い（現仕様）:
  - `User.DoesNotExist` は該当行をスキップ（全体は失敗させない）
  - インポート完了メッセージは成功件数のみ（スキップ件数は表示されない）

## トラブルシューティング
- pip の自己更新エラー:
  - 対策: `.\.venv\Scripts\python.exe -m pip install --upgrade pip`
- `requirements.txt` が見つからない:
  - カレントディレクトリを確認、またはフルパス指定
  - 例: `.\.venv\Scripts\python.exe -m pip install -r C:\\path\\to\\requirements.txt`
- `fatal: destination path '.' already exists and is not an empty directory.`:
  - 空のディレクトリで `git clone`、または新しいフォルダを作成してクローン
  - 既存フォルダをそのまま使う場合は中身退避・削除後に実行
- 旧パスを維持したい（チャットや既存設定の都合）:
  - ディレクトリジャンクションで旧→新を関連付け
  - 例: `cmd /c mklink /J "C:\\Users\\...\\Daily_Report_Internal" "C:\\srv\\Daily_Report_Internal"`

## 付録: クイックコマンド集
```powershell
# 取得
cd C:\srv\Daily_Report_Internal
git clone https://github.com/<ORG>/<REPO>.git .

# 仮想環境・依存
py -3 -m venv .venv
.\.venv\Scripts\Activate.ps1
.\.venv\Scripts\python.exe -m pip install --upgrade pip
.\.venv\Scripts\python.exe -m pip install -r requirements.txt
.\.venv\Scripts\python.exe -m pip install waitress

# 初期化
python manage.py migrate
python manage.py collectstatic --noinput

# 起動テスト
waitress-serve --listen=127.0.0.1:8001 config.wsgi:application

# サービス化（NSSM）
C:\tools\nssm\nssm.exe install daily-report-internal "C:\srv\Daily_Report_Internal\.venv\Scripts\waitress-serve.exe" ^
--listen=127.0.0.1:8001 config.wsgi:application
C:\tools\nssm\nssm.exe start daily-report-internal

# 更新
git pull
.\.venv\Scripts\python.exe -m pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput
C:\tools\nssm\nssm.exe restart daily-report-internal
```

---

## 完全セットアップ手順（別サーバー向け・実践版）

この手順は実際の構築作業で得られた知見を反映した、つまずかないための詳細版です。

### 前提条件の確認

- Windows Server 2016 以降（または Windows 10/11）
- Git がインストール済み（`git --version` で確認）
- Python 3.8+ がインストール済み（`py -3 --version` で確認）
- 管理者権限でコマンドを実行可能
- サーバーの固定 IP アドレスを確認（例: `192.168.1.XXX`）

### ステップ1：ツールの準備

#### 1-1. NSSM（サービス管理ツール）のダウンロード

```powershell
# 管理者権限の PowerShell で実行
New-Item -ItemType Directory -Force C:\tools\nssm | Out-Null
Invoke-WebRequest -Uri https://nssm.cc/release/nssm-2.24.zip -OutFile C:\tools\nssm\nssm.zip
Expand-Archive C:\tools\nssm\nssm.zip -DestinationPath C:\tools\nssm -Force
Copy-Item C:\tools\nssm\nssm-2.24\win64\nssm.exe C:\tools\nssm\nssm.exe -Force

# 動作確認
& "C:\tools\nssm\nssm.exe" version
```

**注意**: 企業プロキシ環境などでダウンロードできない場合は、別PCでダウンロードして `C:\tools\nssm\nssm.exe` に配置してください。

#### 1-2. Caddy（リバースプロキシ）のダウンロード

```powershell
# 公式サイトから Windows 64-bit をダウンロード
# https://caddyserver.com/download

# ダウンロード後、展開して配置
New-Item -ItemType Directory -Force C:\tools\caddy | Out-Null
# caddy.exe を C:\tools\caddy\caddy.exe に配置

# 動作確認
C:\tools\caddy\caddy.exe version
```

### ステップ2：プロジェクトの配置

#### 2-1. ディレクトリ作成とクローン

```powershell
# 通常の PowerShell で実行
New-Item -ItemType Directory -Force C:\srv | Out-Null
cd C:\srv
git clone https://github.com/<ORG>/<REPO>.git Daily_Report_Internal
cd C:\srv\Daily_Report_Internal
```

**注意**: リポジトリ URL は実際のものに置き換えてください。

#### 2-2. 仮想環境の作成と依存パッケージのインストール

```powershell
# C:\srv\Daily_Report_Internal で実行
py -3 -m venv .venv
.\.venv\Scripts\Activate.ps1
.\.venv\Scripts\python.exe -m pip install --upgrade pip
.\.venv\Scripts\python.exe -m pip install -r requirements.txt
.\.venv\Scripts\python.exe -m pip install waitress
```

**トラブル時**: `Activate.ps1` が実行できない場合は、管理者権限で以下を実行：
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### ステップ3：本番設定ファイルの編集

#### 3-1. `.env` ファイルの作成

```powershell
# サーバーの IP アドレスに合わせて変更
@'
SECRET_KEY=本番用の十分長いランダム文字列（50文字以上推奨）
URL_SET=192.168.1.XXX
EMAIL_HOST_USER=
EMAIL_HOST_PASSWORD=
'@ | Set-Content -Encoding UTF8 .env
```

**SECRET_KEY の生成例**:
```powershell
# Python で生成
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

#### 3-2. `config/settings.py` の編集

エディタで `config/settings.py` を開き、以下を確認・修正：

```python
# 本番運用では必ず False に
DEBUG = False

# サーバーの IP アドレスを設定（複数可）
ALLOWED_HOSTS = ['192.168.1.XXX', 'localhost', '127.0.0.1']

# CSRF 信頼オリジン（Django 4+ 必須）
CSRF_TRUSTED_ORIGINS = [
    'http://192.168.1.XXX',
    'https://192.168.1.XXX',
]

# 逆プロキシ設定（Caddy 経由のため必須）
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
USE_X_FORWARDED_HOST = True

# SQLite 同時書き込み待機設定
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
        'OPTIONS': {
            'timeout': 20,
        }
    }
}

# 静的ファイル出力先
STATIC_ROOT = BASE_DIR / 'static'
```

**重要**: `192.168.1.XXX` は実際のサーバー IP に置き換えてください。

### ステップ4：データベース初期化と静的ファイル収集

```powershell
# 仮想環境が有効な状態で実行
cd C:\srv\Daily_Report_Internal
.\.venv\Scripts\Activate.ps1

# データベースのマイグレーション
python manage.py migrate

# 静的ファイルの収集（CSS/JS など）
python manage.py collectstatic --noinput

# 管理者ユーザーの作成（初回のみ）
python manage.py createsuperuser
# ユーザー名、メールアドレス、パスワードを入力
```

**注意**: `createsuperuser` で入力したユーザー名とパスワードは必ずメモしてください。

### ステップ5：Waitress 起動用スクリプトの作成

通常の `waitress-serve.exe` コマンドでは作業ディレクトリの問題で起動しないため、ラッパースクリプトを作成します。

```powershell
# serve_waitress.py を作成
@'
import os
os.chdir(r"C:\srv\Daily_Report_Internal")
from waitress import serve
from config.wsgi import application
serve(application, listen="127.0.0.1:8001")
'@ | Set-Content -Encoding UTF8 C:\srv\Daily_Report_Internal\serve_waitress.py
```

### ステップ6：Caddyfile の作成

```powershell
# サーバーの IP アドレスに合わせて変更
@'
192.168.1.XXX {
    handle_path /static/* {
        root * C:\srv\Daily_Report_Internal\static
        file_server
    }
    reverse_proxy 127.0.0.1:8001
}
'@ | Set-Content -Encoding UTF8 C:\srv\Daily_Report_Internal\Caddyfile

# 構文チェック
C:\tools\caddy\caddy.exe validate --config "C:\srv\Daily_Report_Internal\Caddyfile"
```

**成功時**: `Valid configuration` と表示されます。

### ステップ7：サービス登録（管理者権限必須）

**重要**: ここからは必ず **管理者として PowerShell を起動** してください。

#### 7-1. 管理者権限で PowerShell を開く

- スタートメニューで「PowerShell」を右クリック → 「管理者として実行」
- またはコマンドで起動：
```powershell
Start-Process powershell -Verb RunAs
```

#### 7-2. ログディレクトリの作成

```powershell
# 管理者 PowerShell で実行
New-Item -ItemType Directory -Force C:\srv\Daily_Report_Internal\logs | Out-Null
```

#### 7-3. 既存の同名サービスがあれば削除

```powershell
# エラーが出ても問題ありません（存在しない場合）
sc.exe stop daily-report-internal
sc.exe delete daily-report-internal
sc.exe stop caddy
sc.exe delete caddy
```

#### 7-4. Waitress（Django 本体）をサービス登録

```powershell
# 管理者 PowerShell で実行（& 演算子を忘れずに）
& "C:\tools\nssm\nssm.exe" install daily-report-internal "C:\srv\Daily_Report_Internal\.venv\Scripts\python.exe" "C:\srv\Daily_Report_Internal\serve_waitress.py"
& "C:\tools\nssm\nssm.exe" set daily-report-internal AppDirectory "C:\srv\Daily_Report_Internal"
& "C:\tools\nssm\nssm.exe" set daily-report-internal AppStdout "C:\srv\Daily_Report_Internal\logs\waitress-out.log"
& "C:\tools\nssm\nssm.exe" set daily-report-internal AppStderr "C:\srv\Daily_Report_Internal\logs\waitress-err.log"
& "C:\tools\nssm\nssm.exe" start daily-report-internal
& "C:\tools\nssm\nssm.exe" status daily-report-internal
```

**成功時**: `SERVICE_RUNNING` と表示されます。

#### 7-5. Caddy（リバースプロキシ）をサービス登録

```powershell
# 管理者 PowerShell で実行
& "C:\tools\nssm\nssm.exe" install caddy "C:\tools\caddy\caddy.exe" run --config "C:\srv\Daily_Report_Internal\Caddyfile" --watch
& "C:\tools\nssm\nssm.exe" set caddy AppDirectory "C:\srv\Daily_Report_Internal"
& "C:\tools\nssm\nssm.exe" start caddy
& "C:\tools\nssm\nssm.exe" status caddy
```

**成功時**: `SERVICE_RUNNING` と表示されます。

### ステップ8：ファイアウォール設定

```powershell
# 管理者 PowerShell で実行
netsh advfirewall firewall add rule name="Caddy HTTP 80" dir=in action=allow protocol=TCP localport=80

# HTTPS を使う場合（オプション）
netsh advfirewall firewall add rule name="Caddy HTTPS 443" dir=in action=allow protocol=TCP localport=443
```

### ステップ9：動作確認

#### 9-1. ブラウザでアクセス

別の PC またはサーバー自身のブラウザで以下にアクセス：

```
http://192.168.1.XXX/admin
```

**成功時**: Django 管理画面のログイン画面が表示されます（CSS が適用されてきれいに表示される）。

#### 9-2. ログイン

- ステップ 4 で作成した管理者ユーザー名とパスワードでログイン
- 日報の作成・編集画面が表示されれば成功

### トラブルシューティング（実践編）

#### 問題1: CSRF エラーが出る

**エラー例**: `Origin checking failed - https://192.168.1.XXX does not match any trusted origins.`

**原因**: `CSRF_TRUSTED_ORIGINS` が未設定または IP アドレスが違う

**解決策**:
1. `config/settings.py` の `CSRF_TRUSTED_ORIGINS` に正しい IP を設定
2. Waitress を再起動（管理者 PowerShell）:
```powershell
& "C:\tools\nssm\nssm.exe" restart daily-report-internal
```

#### 問題2: 静的ファイル（CSS/JS）が読み込まれず見栄えが悪い

**原因**: `collectstatic` が未実行または Caddy が起動していない

**解決策**:
```powershell
cd C:\srv\Daily_Report_Internal
.\.venv\Scripts\Activate.ps1
python manage.py collectstatic --noinput

# Caddy を再起動（管理者 PowerShell）
& "C:\tools\nssm\nssm.exe" restart caddy
```

ブラウザで **Ctrl + F5**（スーパーリロード）してキャッシュをクリア。

#### 問題3: サービスが起動しない（1053 エラー）

**エラー例**: `StartService FAILED 1053`

**原因**: `sc.exe create` で登録したサービスは Python アプリを直接起動できない

**解決策**: NSSM を使って登録し直す（ステップ 7 参照）
```powershell
sc.exe delete daily-report-internal
# NSSM で再登録
```

#### 問題4: 管理者権限エラー（エラー 5）

**エラー例**: `OpenSCManager FAILED 5: アクセスが拒否されました。`

**原因**: PowerShell を管理者として実行していない

**解決策**: PowerShell を右クリック → 「管理者として実行」で開き直す

#### 問題5: NSSM コマンドが認識されない

**エラー例**: `用語 'nssm' は、コマンドレット、関数、スクリプト...として認識されません`

**原因**: フルパスで指定していない、または `&` 演算子を付けていない

**解決策**:
```powershell
# 正しい書き方（& 演算子とフルパス）
& "C:\tools\nssm\nssm.exe" status daily-report-internal
```

#### 問題6: Caddy が HTTPS に自動リダイレクトする

**現象**: `http://192.168.1.XXX` にアクセスすると `https://192.168.1.XXX` に転送される

**原因**: Caddy のデフォルト動作（自動 HTTPS）

**解決策**:
- HTTP のみで運用する場合、Caddyfile に `http://` を明示：
```caddy
http://192.168.1.XXX {
    handle_path /static/* {
        root * C:\srv\Daily_Report_Internal\static
        file_server
    }
    reverse_proxy 127.0.0.1:8001
}
```
- HTTPS を使う場合は証明書を設定（Let's Encrypt 自動取得またはローカル証明書）

#### 問題7: 別PCからアクセスできない（ERR_CONNECTION_TIMED_OUT）

**現象**: サーバー自身からは `http://localhost/admin/` でアクセスできるが、別PCから `http://192.168.1.XXX/admin/` にアクセスすると `ERR_CONNECTION_TIMED_OUT` になる

**原因と解決策**:

1. **ファイアウォールで80番ポートが開放されていない**
   ```powershell
   # 管理者 PowerShell で実行
   netsh advfirewall firewall add rule name="Caddy HTTP 80" dir=in action=allow protocol=TCP localport=80
   
   # 確認
   netsh advfirewall firewall show rule name="Caddy HTTP 80"
   ```

2. **Caddyfile で特定IPアドレスを指定している**
   - `192.168.1.XXX {` のように特定IPを指定すると、外部からアクセスできない場合があります
   - **推奨**: `:80` に変更してすべてのインターフェースでリッスン
   ```caddy
   :80 {
       handle_path /static/* {
           root * C:\srv\Daily_Report_Internal\static
           file_server
       }
       reverse_proxy 127.0.0.1:8001
   }
   ```
   - 変更後、Caddy を再起動：
   ```powershell
   & "C:\tools\nssm\nssm.exe" restart caddy
   ```

3. **疎通確認方法**（別PCから）
   ```powershell
   # PowerShell で実行
   Test-NetConnection 192.168.1.XXX -Port 80
   ```
   `TcpTestSucceeded : True` と表示されれば疎通OK

#### 問題8: Chrome でアクセスが遅い、または接続できない（Firefox は正常）

**現象**: 
- Firefox や Chrome シークレットモードでは速くアクセスできる
- Chrome 通常モードだけ遅い、または接続できない

**原因**: Chrome の HSTS キャッシュや古い Cookie/キャッシュが干渉している

**解決策**:

1. **HSTS キャッシュをクリア**
   - Chrome で `chrome://net-internals/#hsts` を開く
   - 「Delete domain security policies」に `192.168.1.XXX` を入力
   - 「Delete」をクリック
   - Chrome を完全に閉じて再起動

2. **閲覧データをクリア**
   - `Ctrl + Shift + Delete` を押す
   - 「期間」を「全期間」に設定
   - 「Cookie と他のサイトデータ」と「キャッシュされた画像とファイル」にチェック
   - 「データを削除」をクリック

3. **シークレットモードで確認**
   - `Ctrl + Shift + N` でシークレットウィンドウを開く
   - `http://192.168.1.XXX/admin/` にアクセス
   - シークレットで速い場合は、通常モードのキャッシュが原因

### サービス管理コマンド集

```powershell
# 管理者 PowerShell で実行

# サービスの状態確認
& "C:\tools\nssm\nssm.exe" status daily-report-internal
& "C:\tools\nssm\nssm.exe" status caddy

# サービスの起動
& "C:\tools\nssm\nssm.exe" start daily-report-internal
& "C:\tools\nssm\nssm.exe" start caddy

# サービスの停止
& "C:\tools\nssm\nssm.exe" stop daily-report-internal
& "C:\tools\nssm\nssm.exe" stop caddy

# サービスの再起動
& "C:\tools\nssm\nssm.exe" restart daily-report-internal
& "C:\tools\nssm\nssm.exe" restart caddy

# サービスの削除
& "C:\tools\nssm\nssm.exe" remove daily-report-internal confirm
& "C:\tools\nssm\nssm.exe" remove caddy confirm

# ログの確認
Get-Content C:\srv\Daily_Report_Internal\logs\waitress-err.log -Tail 50
Get-Content C:\srv\Daily_Report_Internal\logs\waitress-out.log -Tail 50
```

### アプリケーション更新時の手順

```powershell
# 通常の PowerShell で実行
cd C:\srv\Daily_Report_Internal
git pull
.\.venv\Scripts\Activate.ps1
.\.venv\Scripts\python.exe -m pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput

# 管理者 PowerShell で Waitress を再起動
& "C:\tools\nssm\nssm.exe" restart daily-report-internal
```

### バックアップ手順

```powershell
# 管理者 PowerShell でサービス停止
& "C:\tools\nssm\nssm.exe" stop daily-report-internal

# データベースとプロジェクトをバックアップ
$backupDir = "C:\Backup\Daily_Report_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
New-Item -ItemType Directory -Force $backupDir
Copy-Item C:\srv\Daily_Report_Internal\db.sqlite3 $backupDir
Copy-Item C:\srv\Daily_Report_Internal\.env $backupDir

# サービス再開
& "C:\tools\nssm\nssm.exe" start daily-report-internal
```

---

## 実際の構築記録（192.168.1.196 での構築完了）

### 構築日時
2025年9月30日

### 構築環境
- サーバーIP: `192.168.1.196`
- OS: Windows
- Python: 3.x
- 採用構成: **Waitress + Caddy**

### 構築手順の概要

1. **ツール準備**
   - NSSM 2.24 を `C:\tools\nssm\nssm.exe` に配置
   - Caddy v2.10.2 を `C:\tools\caddy\caddy.exe` に配置

2. **プロジェクト配置**
   - `C:\srv\Daily_Report_Internal` にクローン
   - 仮想環境作成（`.venv`）
   - 依存パッケージインストール（`requirements.txt` + `waitress`）

3. **設定ファイル編集**
   - `.env`: `SECRET_KEY`、`URL_SET=192.168.1.196` を設定
   - `config/settings.py`:
     - `DEBUG = False`
     - `ALLOWED_HOSTS = ['192.168.1.196', 'localhost', '127.0.0.1']`
     - `CSRF_TRUSTED_ORIGINS = ['http://192.168.1.196', 'https://192.168.1.196']`
     - `SECURE_PROXY_SSL_HEADER` と `USE_X_FORWARDED_HOST` を追加
     - `DATABASES['default']['OPTIONS'] = {'timeout': 20}` を追加

4. **データベース初期化**
   - `python manage.py migrate`
   - `python manage.py collectstatic --noinput`
   - `python manage.py createsuperuser`

5. **Waitress 起動スクリプト作成**
   - `serve_waitress.py` を作成（作業ディレクトリ問題の回避）

6. **Caddyfile 作成**
   - 最終設定: `:80` でリッスン（すべてのインターフェース）
   - 静的ファイル配信と Waitress へのリバースプロキシ設定

7. **サービス登録（NSSM）**
   - `daily-report-internal`: Waitress（Django本体）
   - `caddy`: リバースプロキシ
   - 両方とも `SERVICE_RUNNING` で起動成功

8. **ファイアウォール設定**
   - 80番ポート開放（`Caddy HTTP 80` ルール追加）

9. **動作確認**
   - サーバー自身: `http://localhost/admin/` でアクセス成功
   - 別PC（192.168.1.190）: `http://192.168.1.196/admin/` でアクセス成功
   - 応答時間: 約1.4秒

### 発生したトラブルと解決

1. **CSRF エラー**
   - 原因: `CSRF_TRUSTED_ORIGINS` 未設定
   - 解決: `settings.py` に追加して Waitress 再起動

2. **静的ファイル未配信（CSS/JS が効かない）**
   - 原因: `collectstatic` 未実行
   - 解決: `python manage.py collectstatic --noinput` 実行

3. **サービス起動失敗（1053エラー）**
   - 原因: `sc.exe create` で登録すると Python アプリが起動しない
   - 解決: NSSM で登録し直し

4. **別PCからアクセスできない（タイムアウト）**
   - 原因1: ファイアウォールで80番ポート未開放
   - 解決1: `netsh advfirewall firewall add rule` で開放
   - 原因2: Caddyfile で `192.168.1.196 {` と特定IP指定
   - 解決2: `:80 {` に変更してすべてのインターフェースでリッスン

5. **Chrome でアクセスが遅い（Firefox は正常）**
   - 原因: Chrome の HSTS キャッシュや古い Cookie が干渉
   - 解決: 閲覧データクリア、または `chrome://net-internals/#hsts` で HSTS 削除

### 最終的な構成

```
[クライアント PC] 
    ↓ http://192.168.1.196/admin/
[Caddy (80番ポート)]
    ↓ reverse_proxy
[Waitress (127.0.0.1:8001)]
    ↓
[Django アプリケーション]
    ↓
[SQLite データベース]
```

### 運用開始後の確認項目

- ✅ 管理画面ログイン成功
- ✅ 日報の作成・編集・提出が可能
- ✅ 静的ファイル（CSS/JS）正常配信
- ✅ 別PCからのアクセス成功
- ✅ サービス自動起動設定完了

### 今後の課題

- [ ] HTTPS 対応（証明書設定）
- [ ] 定期バックアップスクリプト作成
- [ ] パフォーマンスチューニング（必要に応じて）
- [ ] ログローテーション設定


